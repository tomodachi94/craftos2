MAKEFLAGS+=--warn-undefined-variables
CC=@CC@
CXX=@CXX@
CFLAGS=@CFLAGS@
CPPFLAGS=@CPPFLAGS@ -I@srcdir@/api
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
LIBEXT=.so
ifndef OS
ifeq (@OUT_TARGET@, craftos)
ifeq ($(shell uname), Linux)
EXTRA_PLATFORM_INSTALL_TARGETS=install-linux fixup-liblua-path
endif
endif
endif
ifndef OS
ifeq (@OUT_TARGET@, craftos)
ifeq ($(shell uname), Darwin)
LIBEXT=.dylib
EXTRA_PLATFORM_INSTALL_TARGETS=install-darwin
endif
endif
endif
LIBS=craftos2-lua/src/liblua$(LIBEXT) @LIBS@
ifndef OS
ifeq (@OUT_TARGET@, craftos)
ifeq ($(shell uname), Darwin)
LIBS+= -framework ApplicationServices
LIBEXT=.dylib
endif
endif
endif
INSTALL_TARGETS?=install-bin install-headers install-liblua $(EXTRA_PLATFORM_INSTALL_TARGETS)
PREFIX?=@prefix@
prefix=$(PREFIX)
exec_prefix=@exec_prefix@
ifdef DESTDIR
$(error "The DESTDIR variable was removed. Please set PREFIX if you would like to change where everything will be installed, or set BINDIR if you would like to change where binaries will be installed.")
endif
BINDIR=@bindir@
SHAREDIR=@datarootdir@
INCLUDEDIR=@includedir@
LIBDIR=@libdir@
MACAPPDIR=$(PREFIX)/Applications
LIBLUA_NAME=libcraftos2-liblua
ifneq (/usr,$(PREFIX))
CPPFLAGS:=$(CPPFLAGS) -DCUSTOM_ROM_DIR=\"$(SHAREDIR)/craftos\"
endif
SDIR=@srcdir@/src
IDIR=@srcdir@/api
ODIR=obj
_OBJ=Computer.o configuration.o favicon.o font.o gif.o main.o plugin.o runtime.o speaker_sounds.o termsupport.o util.o \
	 apis_config.o apis_fs.o apis_fs_handle.o @HTTP_TARGET@ apis_mounter.o apis_os.o apis_periphemu.o apis_peripheral.o apis_redstone.o apis_term.o \
	 peripheral_monitor.o peripheral_printer.o peripheral_computer.o peripheral_modem.o peripheral_drive.o peripheral_debugger.o \
	 peripheral_debug_adapter.o peripheral_speaker.o peripheral_chest.o peripheral_energy.o peripheral_tank.o \
	 terminal_SDLTerminal.o terminal_CLITerminal.o terminal_RawTerminal.o terminal_TRoRTerminal.o terminal_HardwareSDLTerminal.o @OBJS@
OBJ = $(patsubst %,$(ODIR)/%,$(_OBJ))

all: $(ODIR) @OUT_TARGET@

craftos2-lua:
	git submodule update --init --recursive

craftos2-lua/src/liblua$(LIBEXT): craftos2-lua
	$(error Please build Lua for your platform inside the craftos2-lua directory. You can do this with `make -C craftos2-lua <platform>`, where <platform> is a platform listed with `make -C craftos2-lua`, usually linux or macosx.)

@OUT_TARGET@: craftos2-lua/src/liblua$(LIBEXT) $(OBJ) $(ODIR)/platform.o
	echo " [LD]    $@"
	$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)

macapp: craftos2-lua/src/liblua$(LIBEXT) $(OBJ) $(ODIR)/platform_macapp.o
	mkdir -p CraftOS-PC.app/Contents/MacOS
	mkdir -p CraftOS-PC.app/Contents/Resources
	echo " [LD]    CraftOS-PC.app/Contents/MacOS/craftos"
	clang++ $(LDFLAGS) -o CraftOS-PC.app/Contents/MacOS/craftos $^ $(LIBS) -F/Library/Frameworks -framework Foundation -framework AppKit -mmacosx-version-min=10.9.5
	install_name_tool -add_rpath @executable_path/../Frameworks CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/libharu/lib/libhpdf-2.3.0.dylib "@rpath/libhpdf-2.3.0.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/libpng/lib/libpng16.16.dylib "@rpath/libpng16.16.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoNetSSL.71.dylib "@rpath/libPocoNetSSL.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoCrypto.71.dylib "@rpath/libPocoCrypto.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoFoundation.71.dylib "@rpath/libPocoFoundation.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoJSON.71.dylib "@rpath/libPocoJSON.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoNet.71.dylib "@rpath/libPocoNet.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoUtil.71.dylib "@rpath/libPocoUtil.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/poco/lib/libPocoXML.71.dylib "@rpath/libPocoXML.71.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/lib/libSDL2_mixer-2.0.0.dylib "@rpath/libSDL2_mixer-2.0.0.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/sdl2/lib/libSDL2-2.0.0.dylib "@rpath/libSDL2-2.0.0.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/flac/lib/libFLAC.8.dylib "@rpath/libFLAC.8.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/mpg123/lib/libmpg123.0.dylib "@rpath/libmpg123.0.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/openssl@1.1/lib/libcrypto.1.1.dylib "@rpath/libcrypto.1.1.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	install_name_tool -change /usr/local/opt/openssl@1.1/lib/libssl.1.1.dylib "@rpath/libssl.1.1.dylib" CraftOS-PC.app/Contents/MacOS/craftos
	cp resources/Info.plist CraftOS-PC.app/Contents/
ifneq (,$(wildcard codesign/Makefile))
	make -C codesign
endif

$(ODIR):
	mkdir $@

$(ODIR)/main.o: $(SDIR)/main.cpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/platform_macapp.o: $(SDIR)/platform/macapp.mm $(SDIR)/platform.hpp
	echo " [OBJC]  $@"
	clang++ -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/platform.o: $(SDIR)/platform.cpp $(SDIR)/platform.hpp $(SDIR)/platform/linux.cpp $(SDIR)/platform/darwin.cpp $(SDIR)/platform/emscripten.cpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/http_emscripten.o: $(SDIR)/http_emscripten.cpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/%.o: $(SDIR)/%.c
	echo " [CC]    $@"
	$(CC) -o $@ -c $(CPPFLAGS) $(CFLAGS) $<

$(ODIR)/%.o: $(SDIR)/%.cpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/peripheral_%.o: $(SDIR)/peripheral/%.cpp $(SDIR)/peripheral/%.hpp $(IDIR)/peripheral.hpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/peripheral_computer.o: $(SDIR)/peripheral/computer_p.cpp $(SDIR)/peripheral/computer.hpp $(IDIR)/peripheral.hpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/speaker_sounds.o: $(SDIR)/peripheral/speaker_sounds.cpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/terminal_%.o: $(SDIR)/terminal/%.cpp $(SDIR)/terminal/%.hpp $(IDIR)/Terminal.hpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/apis_%.o: $(SDIR)/apis/%.cpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

$(ODIR)/apis_%_handle.o: $(SDIR)/apis/handles/%_handle.cpp $(SDIR)/apis/handles/%_handle.hpp $(IDIR)/Computer.hpp $(IDIR)/lib.hpp $(SDIR)/util.hpp
	echo " [CXX]   $@"
	$(CXX) -o $@ -c $(CPPFLAGS) $(CXXFLAGS) $(CFLAGS) $<

resources/linux-icons: resources/linux-icons.zip
	unzip resources/linux-icons.zip -d resources/linux-icons

mac-plugin:
	echo " [LD]    ccemux.bundle"
	$(CXX) -std=c++17 -bundle -fpic -o ccemux.bundle examples/ccemux.cpp craftos2-lua/src/liblua$(LIBEXT) -lSDL2 -Icraftos2-lua/include -Iapi

linux-plugin:
	echo " [LD]    ccemux.so"
	$(CXX) -std=c++17 -shared -fPIC -o ccemux.so examples/ccemux.cpp craftos2-lua/src/liblua$(LIBEXT) -lSDL2 -Icraftos2-lua/include -Iapi

clean: $(ODIR)
	rm -f craftos
	rm -rf resources/linux-icons
	find obj -type f -not -name speaker_sounds.o -exec rm -f {} \;

rebuild: clean craftos

fixup-liblua-path: craftos
	echo " [FIXUP] craftos"
	patchelf --replace-needed craftos2-lua/src/liblua.so "$(LIBLUA_NAME)$(LIBEXT)" craftos

install-darwin: macapp
	cp -r CraftOS-PC.app $(MACAPPDIR)

install-linux: resources/linux-icons
	echo " [MKDIR] $(SHAREDIR)/applications"
	mkdir -p "$(SHAREDIR)/applications"
	echo " [CP]    resources/CraftOS-PC.desktop"
	cp resources/CraftOS-PC.desktop "$(SHAREDIR)/applications"
	
	for dimension in 16 24 32 48 64 96 128 256 1024; do \
	 	icondir="$(SHAREDIR)/icons/hicolor/$${dimension}x$${dimension}/apps"; \
		echo " [MKDIR] $${icondir}"; \
		mkdir -p "$${icondir}"; \
		echo " [CP]    resources/linux-icons/$${dimension}.png"; \
		cp "resources/linux-icons/$${dimension}.png" "$${icondir}/craftos.png"; \
	done

install-headers:
	echo " [MKDIR] $(INCLUDEDIR)"
	mkdir -p "$(INCLUDEDIR)"
	echo " [CP]    api"
	cp -R api "$(INCLUDEDIR)/CraftOS-PC"

install-bin: craftos $(filter fixup-liblua-path,$(MAKECMDGOALS))
	echo " [MKDIR] $(BINDIR)"
	mkdir $(BINDIR)
	echo " [CP]    craftos"
	cp craftos "$(BINDIR)/craftos"

# craftos2-lua does have a ``make install`` rule, but it installs a lot of
# files that conflict with a standard Lua installation.
install-liblua: craftos2-lua/src/liblua$(LIBEXT)
	echo " [MKDIR] $(LIBDIR)"
	mkdir $(LIBDIR)
	echo " [CP]    craftos2-lua/src/liblua$(LIBEXT)"
	cp craftos2-lua/src/liblua$(LIBEXT) $(LIBDIR)/$(LIBLUA_NAME)$(LIBEXT)

install: $(INSTALL_TARGETS)

uninstall:
	echo " [RM]    $(BINDIR)/craftos"
	rm -f "$(BINDIR)/craftos"
	echo " [RM]    $(SHAREDIR)/applications/CraftOS-PC.desktop"
	rm -f "$(SHAREDIR)/applications/CraftOS-PC.desktop"
	echo ' [RM]    $(SHAREDIR)/icons/hicolor/*/apps/craftos.png'
	rm -f "$(SHAREDIR)/icons/hicolor/*/apps/craftos.png"
	echo ' [RM]    $(LIBDIR)/$(LIBLUA_NAME)$(LIBEXT)'
	rm -f "$(LIBDIR)/$(LIBLUA_NAME)$(LIBEXT)"
	echo ' [RM]    $(INCLUDEDIR)/CraftOS-PC'
	rm -rf "$(INCLUDEDIR)/CraftOS-PC"
	echo ' [RM]    $(MACAPPDIR)/CraftOS-PC.app'
	rm -rf "$(MACAPPDIR)/CraftOS-PC.app"


test: craftos
	./craftos --headless --script $(shell pwd)/resources/CraftOSTest.lua -d "$(shell mktemp -d)"

.PHONY: all macapp clean rebuild install install-bin install-headers install-liblua install-linux install-darwin uninstall test
.SILENT:
